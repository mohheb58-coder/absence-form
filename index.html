<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ø«Ø¨Øª ØºÛŒØ¨Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Tahoma', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .form-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }
        
        input, select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            margin-left: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .students-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .students-table th,
        .students-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }
        
        .students-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }
        
        .students-table tr:hover {
            background: #f3f4f6;
        }
        
        .checkbox-cell {
            text-align: center;
        }
        
        .checkbox-cell input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .filter-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .report-box {
            background: #f3f4f6;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
            direction: rtl;
            min-height: 100px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .info-box {
            background: #fef3c7;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .info-box ul {
            margin-right: 20px;
            margin-top: 10px;
        }

        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .success-message.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ« Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ØºÛŒØ¨Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</h1>
            <p>Ø«Ø¨Øª Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª ØºÛŒØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡</p>
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" data-tab="add">â• Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</button>
            <button class="tab-btn" data-tab="absence">âœ… Ø«Ø¨Øª ØºÛŒØ¨Øª</button>
            <button class="tab-btn" data-tab="report">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ù…Ø¯ÛŒØ±</button>
        </div>
        
        <!-- ØªØ¨ Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² -->
        <div id="add-tab" class="tab-content active">
            <div class="form-section">
                <h2>ğŸ“‚ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ (Ø¨Ø±Ø§ÛŒ ØªØ¹Ø¯Ø§Ø¯ Ø²ÛŒØ§Ø¯)</h2>
                <div class="info-box">
                    <p style="margin-bottom: 10px;"><strong>ğŸ“‹ ÙØ±Ù…Øª ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„:</strong></p>
                    <p>ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø´Ù…Ø§ Ø¨Ø§ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø§ÛŒÙ† Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯:</p>
                    <p style="margin: 10px 0; font-family: monospace; background: white; padding: 10px; border-radius: 5px;">
                        Ù†Ø§Ù… | Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ | Ù¾Ø§ÛŒÙ‡ | Ú©Ù„Ø§Ø³ | Ù…Ø¹Ù„Ù…
                    </p>
                    <p style="color: #dc2626;"><strong>âš ï¸ Ù†Ú©Ø§Øª Ù…Ù‡Ù…:</strong></p>
                    <ul>
                        <li>Ø³Ø·Ø± Ø§ÙˆÙ„ Ø¨Ø§ÛŒØ¯ Ø¹Ù†ÙˆØ§Ù† Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ Ø¨Ø§Ø´Ø¯</li>
                        <li>Ù¾Ø§ÛŒÙ‡ Ø¨Ø§ÛŒØ¯: Ø§ÙˆÙ„ØŒ Ø¯ÙˆÙ… ÛŒØ§ Ø³ÙˆÙ… Ø¨Ø§Ø´Ø¯</li>
                        <li>Ú©Ù„Ø§Ø³ Ø¨Ø§ÛŒØ¯ Ø¹Ø¯Ø¯ Ø¨ÛŒÙ† 1 ØªØ§ 6 Ø¨Ø§Ø´Ø¯</li>
                        <li><strong>ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ØŒ Ù„ÛŒØ³Øª Ù‚Ø¨Ù„ÛŒ Ø±Ø§ Ù¾Ø§Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯</strong></li>
                    </ul>
                </div>
                <input type="file" id="excel-file" accept=".xlsx,.xls,.csv" style="margin-bottom: 10px;">
                <button class="btn btn-primary" id="upload-btn">ğŸ“¤ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„</button>
                <button class="btn btn-success" id="download-template-btn">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ù…ÙˆÙ†Ù‡ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„</button>
                <div id="upload-message" class="success-message"></div>
            </div>
            
            <div class="form-section">
                <h2>Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¬Ø¯ÛŒØ¯ (ØªÚ©â€ŒØ¨Ù‡â€ŒØªÚ©)</h2>
                <form id="student-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Ù†Ø§Ù…:</label>
                            <input type="text" id="firstName" required>
                        </div>
                        <div class="form-group">
                            <label>Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</label>
                            <input type="text" id="lastName" required>
                        </div>
                        <div class="form-group">
                            <label>Ù¾Ø§ÛŒÙ‡:</label>
                            <select id="grade" required>
                                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                                <option value="Ø§ÙˆÙ„">Ø§ÙˆÙ„</option>
                                <option value="Ø¯ÙˆÙ…">Ø¯ÙˆÙ…</option>
                                <option value="Ø³ÙˆÙ…">Ø³ÙˆÙ…</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ú©Ù„Ø§Ø³:</label>
                            <select id="classNum" required>
                                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ù…Ø¹Ù„Ù… Ú©Ù„Ø§Ø³:</label>
                            <input type="text" id="teacher" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</button>
                </form>
                <div id="add-message" class="success-message"></div>
            </div>
            
            <div class="form-section">
                <h2>Ù„ÛŒØ³Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ø«Ø¨Øª Ø´Ø¯Ù‡ (ØªØ¹Ø¯Ø§Ø¯: <span id="student-count">0</span>)</h2>
                <div id="students-list"></div>
            </div>
        </div>
        
        <!-- ØªØ¨ Ø«Ø¨Øª ØºÛŒØ¨Øª -->
        <div id="absence-tab" class="tab-content">
            <div class="form-section">
                <h2>Ø«Ø¨Øª ØºÛŒØ¨Øª Ø§Ù…Ø±ÙˆØ²</h2>
                <div class="filter-section">
                    <div class="form-group">
                        <label>ÙÛŒÙ„ØªØ± Ù¾Ø§ÛŒÙ‡:</label>
                        <select id="filter-grade">
                            <option value="">Ù‡Ù…Ù‡ Ù¾Ø§ÛŒÙ‡â€ŒÙ‡Ø§</option>
                            <option value="Ø§ÙˆÙ„">Ø§ÙˆÙ„</option>
                            <option value="Ø¯ÙˆÙ…">Ø¯ÙˆÙ…</option>
                            <option value="Ø³ÙˆÙ…">Ø³ÙˆÙ…</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ÙÛŒÙ„ØªØ± Ú©Ù„Ø§Ø³:</label>
                        <select id="filter-class">
                            <option value="">Ù‡Ù…Ù‡ Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                    </div>
                </div>
                <div id="absence-table"></div>
                <div class="action-buttons">
                    <button class="btn btn-success" id="save-absences-btn">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ØºÛŒØ¨Øªâ€ŒÙ‡Ø§</button>
                    <button class="btn btn-danger" id="clear-absences-btn">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡</button>
                </div>
                <div id="absence-message" class="success-message"></div>
            </div>
        </div>
        
        <!-- ØªØ¨ Ú¯Ø²Ø§Ø±Ø´ Ù…Ø¯ÛŒØ± -->
        <div id="report-tab" class="tab-content">
            <div class="form-section">
                <h2>Ú¯Ø²Ø§Ø±Ø´ ØºÛŒØ¨Øª Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒØ§</h2>
                <button class="btn btn-primary" id="generate-report-btn">ğŸ“ ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´</button>
                <button class="btn btn-success" id="copy-report-btn" style="margin-right: 10px;">ğŸ“‹ Ú©Ù¾ÛŒ Ú¯Ø²Ø§Ø±Ø´</button>
                <div id="report-content" class="report-box">Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ØŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ "ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let students = [];
        let absences = {};
        const today = new Date().toLocaleDateString('fa-IR');

        // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
        function showSuccessMessage(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.add('show');
            setTimeout(() => {
                el.classList.remove('show');
            }, 3000);
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ø­Ø§ÙØ¸Ù‡
        function loadData() {
            const saved = localStorage.getItem('students');
            if (saved) {
                try {
                    students = JSON.parse(saved);
                } catch(e) {
                    students = [];
                }
            }
            const savedAbsences = localStorage.getItem('absences_' + today);
            if (savedAbsences) {
                try {
                    absences = JSON.parse(savedAbsences);
                } catch(e) {
                    absences = {};
                }
            }
        }

        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        function saveData() {
            localStorage.setItem('students', JSON.stringify(students));
            localStorage.setItem('absences_' + today, JSON.stringify(absences));
        }

        // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù„ÙØ¨Ø§
       function sortStudents() {
    students.sort((a, b) => {
        // Ø§Ø¨ØªØ¯Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ
        const lastNameCompare = a.lastName.localeCompare(b.lastName, 'fa');
        if (lastNameCompare !== 0) {
            return lastNameCompare;
        }
        // Ø§Ú¯Ø± Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ ÛŒÚ©Ø³Ø§Ù† Ø¨ÙˆØ¯ØŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù…
        return a.firstName.localeCompare(b.firstName, 'fa');
    });
}

        // ØªØºÛŒÛŒØ± ØªØ¨
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tab = this.getAttribute('data-tab');
                
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                
                document.getElementById(tab + '-tab').classList.add('active');
                this.classList.add('active');
                
                if (tab === 'absence') {
                    renderAbsenceTable();
                } else if (tab === 'report') {
                    generateReport();
                } else if (tab === 'add') {
                    renderStudentsList();
                }
            });
        });

        // Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
        document.getElementById('student-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const student = {
                id: Date.now(),
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                grade: document.getElementById('grade').value,
                classNum: document.getElementById('classNum').value,
                teacher: document.getElementById('teacher').value.trim()
            };
            
            students.push(student);
            sortStudents();
            saveData();
            this.reset();
            renderStudentsList();
            showSuccessMessage('add-message', 'âœ… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!');
        });

        // Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†
        function renderStudentsList() {
            const container = document.getElementById('students-list');
            document.getElementById('student-count').textContent = students.length;
            
            if (students.length === 0) {
                container.innerHTML = '<div class="empty-state">Ù‡Ù†ÙˆØ² Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
                return;
            }
            
            sortStudents();
            
            let html = '<table class="students-table"><tr><th>Ø±Ø¯ÛŒÙ</th><th>Ù†Ø§Ù…</th><th>Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</th><th>Ù¾Ø§ÛŒÙ‡</th><th>Ú©Ù„Ø§Ø³</th><th>Ù…Ø¹Ù„Ù…</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>';
            
            students.forEach((s, index) => {
                html += `<tr>
                    <td>${index + 1}</td>
                    <td>${s.firstName}</td>
                    <td>${s.lastName}</td>
                    <td>${s.grade}</td>
                    <td>${s.classNum}</td>
                    <td>${s.teacher}</td>
                    <td><button class="btn btn-danger delete-btn" data-id="${s.id}">Ø­Ø°Ù</button></td>
                </tr>`;
            });
            
            html += '</table>';
            container.innerHTML = html;

            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø­Ø°Ù
            container.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteStudent(id);
                });
            });
        }

        // Ø­Ø°Ù Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²
        function deleteStudent(id) {
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')) {
                students = students.filter(s => s.id !== id);
                saveData();
                renderStudentsList();
                showSuccessMessage('add-message', 'âœ… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
            }
        }

        // ÙÛŒÙ„ØªØ± Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†
        document.getElementById('filter-grade').addEventListener('change', renderAbsenceTable);
        document.getElementById('filter-class').addEventListener('change', renderAbsenceTable);

        // Ù†Ù…Ø§ÛŒØ´ Ø¬Ø¯ÙˆÙ„ ØºÛŒØ¨Øª
        function renderAbsenceTable() {
            const container = document.getElementById('absence-table');
            const filterGrade = document.getElementById('filter-grade').value;
            const filterClass = document.getElementById('filter-class').value;
            
            let filtered = students.filter(s => {
                return (!filterGrade || s.grade === filterGrade) &&
                       (!filterClass || s.classNum === filterClass);
            });

            // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ
            filtered.sort((a, b) => {
                const lastNameA = a.lastName + ' ' + a.lastName;
                const lastNameB = b.lastNamee + ' ' + b.lastName;
                return lastNameB.localeCompare(lastNameA, 'fa');
            });
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
                return;
            }
            
            let html = '<table class="students-table"><tr><th>Ø±Ø¯ÛŒÙ</th><th>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</th><th>Ù¾Ø§ÛŒÙ‡</th><th>Ú©Ù„Ø§Ø³</th><th>Ù…Ø¹Ù„Ù…</th><th>ØºØ§ÛŒØ¨</th></tr>';
            
            filtered.forEach((s, index) => {
                const isAbsent = absences[s.id] || false;
                html += `<tr>
                    <td>${index + 1}</td>
                    <td>${s.firstName} ${s.lastName}</td>
                    <td>${s.grade}</td>
                    <td>${s.classNum}</td>
                    <td>${s.teacher}</td>
                    <td class="checkbox-cell">
                        <input type="checkbox" ${isAbsent ? 'checked' : ''} 
                               class="absence-checkbox" data-student-id="${s.id}">
                    </td>
                </tr>`;
            });
            
            html += '</table>';
            container.innerHTML = html;
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ø±Ø§ÛŒ Ú†Ú© Ø¨Ø§Ú©Ø³â€ŒÙ‡Ø§
            container.querySelectorAll('.absence-checkbox').forEach(cb => {
                cb.addEventListener('change', function() {
                    const studentId = parseInt(this.getAttribute('data-student-id'));
                    absences[studentId] = this.checked;
                });
            });
        }

        // Ø°Ø®ÛŒØ±Ù‡ ØºÛŒØ¨Øªâ€ŒÙ‡Ø§
        document.getElementById('save-absences-btn').addEventListener('click', function() {
            saveData();
            showSuccessMessage('absence-message', 'âœ… ØºÛŒØ¨Øªâ€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!');
        });

        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØºÛŒØ¨Øªâ€ŒÙ‡Ø§
        document.getElementById('clear-absences-btn').addEventListener('click', function() {
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù‡Ù…Ù‡ ØºÛŒØ¨Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ')) {
                absences = {};
                saveData();
                renderAbsenceTable();
                showSuccessMessage('absence-message', 'âœ… Ù‡Ù…Ù‡ ØºÛŒØ¨Øªâ€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯');
            }
        });

        // ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´
        function generateReport() {
            const container = document.getElementById('report-content');
            
            const absentStudents = students.filter(s => absences[s.id]);
            
            if (absentStudents.length === 0) {
                container.textContent = 'Ø§Ù…Ø±ÙˆØ² Ù‡ÛŒÚ† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ ØºÛŒØ¨Øª Ù†Ø¯Ø§Ø´ØªÙ‡ Ø§Ø³Øª. ğŸ‰';
                return;
            }
            
            let report = `ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ ØºÛŒØ¨Øª Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†\n`;
            report += `ğŸ“… ØªØ§Ø±ÛŒØ®: ${today}\n`;
            report += `ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ ØºØ§ÛŒØ¨ÛŒÙ†: ${absentStudents.length} Ù†ÙØ±\n\n`;
            report += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n`;
            
            // Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾Ø§ÛŒÙ‡ Ùˆ Ú©Ù„Ø§Ø³
            const grouped = {};
            absentStudents.forEach(s => {
                const key = `Ù¾Ø§ÛŒÙ‡ ${s.grade} - Ú©Ù„Ø§Ø³ ${s.classNum}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(s);
            });
            
            // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§
            const sortedKeys = Object.keys(grouped).sort();
            
            sortedKeys.forEach(key => {
                report += `ğŸ“š ${key}\n`;
                report += `ğŸ‘¨â€ğŸ« Ù…Ø¹Ù„Ù…: ${grouped[key][0].teacher}\n\n`;
                
                // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ø¯Ø± Ù‡Ø± Ú¯Ø±ÙˆÙ‡
                grouped[key].sort((a, b) => {
                    const nameA = a.firstName + ' ' + a.lastName;
                    const nameB = b.firstName + ' ' + b.lastName;
                    return nameA.localeCompare(nameB, 'fa');
                });
                
                grouped[key].forEach((s, i) => {
                    report += `   ${i + 1}. ${s.firstName} ${s.lastName}\n`;
                });
                report += `\n`;
            });
            
            report += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
            report += `\nğŸ™ Ù„Ø·ÙØ§Ù‹ Ø¯Ø± Ø§Ø³Ø±Ø¹ ÙˆÙ‚Øª Ø¬Ù‡Øª Ù…ÙˆØ¬Ù‡ Ú©Ø±Ø¯Ù† ØºÛŒØ¨Øª Ø§Ù‚Ø¯Ø§Ù… Ù†Ù…Ø§ÛŒÛŒØ¯.`;
            
            container.textContent = report;
        }

        document.getElementById('generate-report-btn').addEventListener('click', function() {
            generateReport();
        });

        // Ú©Ù¾ÛŒ Ú¯Ø²Ø§Ø±Ø´
        document.getElementById('copy-report-btn').addEventListener('click', function() {
            const report = document.getElementById('report-content').textContent;
            if (report && report !== 'Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ØŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ "ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯') {
                navigator.clipboard.writeText(report).then(() => {
                    alert('âœ… Ú¯Ø²Ø§Ø±Ø´ Ú©Ù¾ÛŒ Ø´Ø¯!');
                }).catch(() => {
                    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
                });
            } else {
                alert('âš ï¸ Ø§Ø¨ØªØ¯Ø§ Ú¯Ø²Ø§Ø±Ø´ Ø±Ø§ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯');
            }
        });

        // Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„
        document.getElementById('upload-btn').addEventListener('click', function() {
            const fileInput = document.getElementById('excel-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯!');
                return;
            }

            if (students.length > 0) {
                if (!confirm('âš ï¸ Ø¨Ø§ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ØŒ ØªÙ…Ø§Ù… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† Ù‚Ø¨Ù„ÛŒ Ù¾Ø§Ú© Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.\n\nØ¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                    return;
                }
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª Ù‚Ø¨Ù„ÛŒ
                    students = [];
                    
                    let successCount = 0;
                    let errorCount = 0;
                    
                    rows.forEach((row, index) => {
                        const firstName = row['Ù†Ø§Ù…'] || row['name'] || row['Name'];
                        const lastName = row['Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ'] || row['Ù†Ø§Ù…_Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ'] || row['family'] || row['Family'];
                        const grade = row['Ù¾Ø§ÛŒÙ‡'] || row['grade'] || row['Grade'];
                        const classNum = row['Ú©Ù„Ø§Ø³'] || row['class'] || row['Class'];
                        const teacher = row['Ù…Ø¹Ù„Ù…'] || row['teacher'] || row['Teacher'];
                        
                        if (firstName && lastName && grade && classNum && teacher) {
                            students.push({
                                id: Date.now() + index,
                                firstName: String(firstName).trim(),
                                lastName: String(lastName).trim(),
                                grade: String(grade).trim(),
                                classNum: String(classNum).trim(),
                                teacher: String(teacher).trim()
                            });
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    });
                    
                    sortStudents();
                    saveData();
                    renderStudentsList();
                    fileInput.value = '';
                    
                    showSuccessMessage('upload-message', `âœ… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!\nâœ”ï¸ Ù…ÙˆÙÙ‚: ${successCount} Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² | âŒ Ø®Ø·Ø§: ${errorCount} Ø±Ø¯ÛŒÙ`);
                    
                } catch (error) {
                    alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„!\n\nÙ„Ø·ÙØ§Ù‹ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.');
                    console.error(error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        });

        // Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ù…ÙˆÙ†Ù‡ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„
        document.getElementById('download-template-btn').addEventListener('click', function() {
            const template = [
                ['Ù†Ø§Ù…', 'Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ', 'Ù¾Ø§ÛŒÙ‡', 'Ú©Ù„Ø§Ø³', 'Ù…Ø¹Ù„Ù…'],
                ['Ø¹Ù„ÛŒ', 'Ø§Ø­Ù…Ø¯ÛŒ', 'Ø§ÙˆÙ„', '1', 'Ø®Ø§Ù†Ù… Ø±Ø¶Ø§ÛŒÛŒ'],
                ['Ø²Ù‡Ø±Ø§', 'Ù…Ø­Ù…Ø¯ÛŒ', 'Ø§ÙˆÙ„', '1', 'Ø®Ø§Ù†Ù… Ø±Ø¶Ø§ÛŒÛŒ'],
                ['Ø­Ø³ÛŒÙ†', 'Ú©Ø±ÛŒÙ…ÛŒ', 'Ø¯ÙˆÙ…', '2', 'Ø¢Ù‚Ø§ÛŒ Ø­Ø³ÛŒÙ†ÛŒ'],
                ['ÙØ§Ø·Ù…Ù‡', 'Ù†ÙˆØ±ÛŒ', 'Ø³ÙˆÙ…', '3', 'Ø®Ø§Ù†Ù… ØµØ§Ù„Ø­ÛŒ']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†');
            
            XLSX.writeFile(wb, 'Ù†Ù…ÙˆÙ†Ù‡_Ù„ÛŒØ³Øª_Ø¯Ø§Ù†Ø´_Ø¢Ù…ÙˆØ²Ø§Ù†.xlsx');
        });

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        loadData();
        renderStudentsList();
    </script>
</body>

</html>
